// DO NOT EDIT THIS FILE! IT IS GENERATED EACH TIME "capacitor update" IS RUN
def capacitorProjectRoot = "../.."

private static def findNode(File dir, String name) {
    File f = new File(dir, name)
    if (f.exists()) {
        return f.getAbsolutePath()
    }
    if (dir.getParentFile() != null) {
        return findNode(dir.getParentFile(), name)
    }
    return null
}

private static def readJSON(File jsonFile) {
    return new groovy.json.JsonSlurper().parseText(jsonFile.text)
}

private def getCapacitorPlugins() {
    def coreDir = findNode(project.projectDir, "node_modules/@capacitor/core")
    if (coreDir == null) {
        return [];
    }
    def plugins = []
    File capConfigFile = new File(findNode(project.projectDir, "capacitor.config.json"))
    if (!capConfigFile.exists()) {
        capConfigFile = new File(findNode(project.projectDir, "capacitor.config.ts"))
    }
    if (capConfigFile.exists()) {
        def capConfig
        if (capConfigFile.getName().endsWith(".ts")) {
            def text = capConfigFile.text
            def jsonText = text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1)
            capConfig = new groovy.json.JsonSlurper().parseText(jsonText)
        } else {
            capConfig = readJSON(capConfigFile)
        }
        if (capConfig.plugins != null) {
            capConfig.plugins.each { plugin, config ->
                if (plugin != "SplashScreen" && plugin != "App") {
                    def npmPackage = "@capacitor/" + plugin.toLowerCase()
                    def pluginPath = findNode(project.projectDir, "node_modules/" + npmPackage)
                    if (pluginPath != null) {
                        def packageJsonFile = new File(pluginPath, "package.json")
                        if (packageJsonFile.exists()) {
                            def packageJson = readJSON(packageJsonFile)
                            if (packageJson.capacitor?.android?.src != null) {
                                def pluginProjectName = packageJson.name.replaceFirst("@capacitor/", "capacitor-")
                                def pluginSrc = packageJson.capacitor.android.src
                                def pluginProjectDir = new File(pluginPath, pluginSrc)
                                plugins.add([ name: pluginProjectName, path: pluginProjectDir ])
                            }
                        }
                    }
                }
            }
        }
    }

    new File(findNode(project.projectDir, "node_modules")).eachFileMatch(~/capacitor-.*|@capacitor\/.*/) { file ->
        def packageJsonFile
        def capacitorPlugin
        if (file.isDirectory()) {
            if (file.getName().startsWith("@")) {
                file.eachFileMatch(~/capacitor-.*/) { orgFile ->
                    packageJsonFile = new File(orgFile, "package.json")
                    capacitorPlugin = readJSON(packageJsonFile)
                    if (capacitorPlugin.capacitor?.android?.src != null) {
                        def pluginProjectName = capacitorPlugin.name.replaceFirst("@", "").replaceFirst("/", "-")
                        def pluginSrc = capacitorPlugin.capacitor.android.src
                        def pluginProjectDir = new File(orgFile, pluginSrc)
                        plugins.add([ name: pluginProjectName, path: pluginProjectDir ])
                    }
                }
            } else {
                packageJsonFile = new File(file, "package.json")
                capacitorPlugin = readJSON(packageJsonFile)
                if (capacitorPlugin.capacitor?.android?.src != null) {
                    def pluginProjectName = capacitorPlugin.name
                    def pluginSrc = capacitorPlugin.capacitor.android.src
                    def pluginProjectDir = new File(file, pluginSrc)
                    plugins.add([ name: pluginProjectName, path: pluginProjectDir ])
                }
            }
        }
    }
    return plugins
}

ext.capacitorPlugins = getCapacitorPlugins()

android.buildTypes {
    debug {
        if (System.getenv("CAPACITOR_ANDROID_DEBUG_SIGNING_PASS") != null) {
            signingConfig signingConfigs.debug
            android.signingConfigs.debug.storeFile = file(System.getenv("CAPACITOR_ANDROID_DEBUG_SIGNING_STORE_FILE_PATH"))
            android.signingConfigs.debug.storePassword = System.getenv("CAPACITOR_ANDROID_DEBUG_SIGNING_STORE_PASS")
            android.signingConfigs.debug.keyAlias = System.getenv("CAPACITOR_ANDROID_DEBUG_SIGNING_KEY_ALIAS")
            android.signingConfigs.debug.keyPassword = System.getenv("CAPACITOR_ANDROID_DEBUG_SIGNING_KEY_PASS")
        }
    }
}
